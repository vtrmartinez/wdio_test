'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _extends2 = require('babel-runtime/helpers/extends');

var _extends3 = _interopRequireDefault(_extends2);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _createClass2 = require('babel-runtime/helpers/createClass');

var _createClass3 = _interopRequireDefault(_createClass2);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _helpers = require('./helpers');

var _attachment_manager = require('./attachment_manager');

var _attachment_manager2 = _interopRequireDefault(_attachment_manager);

var _status = require('../status');

var _status2 = _interopRequireDefault(_status);

var _step_runner = require('./step_runner');

var _step_runner2 = _interopRequireDefault(_step_runner);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var TestCaseRunner = function () {
  function TestCaseRunner(_ref) {
    var _this = this;

    var eventBroadcaster = _ref.eventBroadcaster,
        skip = _ref.skip,
        testCase = _ref.testCase,
        supportCodeLibrary = _ref.supportCodeLibrary,
        worldParameters = _ref.worldParameters;
    (0, _classCallCheck3.default)(this, TestCaseRunner);

    var attachmentManager = new _attachment_manager2.default(function (_ref2) {
      var data = _ref2.data,
          media = _ref2.media;

      _this.emit('test-step-attachment', {
        index: _this.testStepIndex,
        data: data,
        media: media
      });
    });
    this.eventBroadcaster = eventBroadcaster;
    this.skip = skip;
    this.testCase = testCase;
    this.supportCodeLibrary = supportCodeLibrary;
    this.world = new supportCodeLibrary.World({
      attach: attachmentManager.create.bind(attachmentManager),
      parameters: worldParameters
    });
    this.beforeHookDefinitions = this.getBeforeHookDefinitions();
    this.afterHookDefinitions = this.getAfterHookDefinitions();
    this.testStepIndex = 0;
    this.result = {
      duration: 0,
      status: this.skip ? _status2.default.SKIPPED : _status2.default.PASSED
    };
  }

  (0, _createClass3.default)(TestCaseRunner, [{
    key: 'emit',
    value: function emit(name, data) {
      var sourceLocation = {
        uri: this.testCase.uri,
        line: this.testCase.pickle.locations[0].line
      };
      var eventData = (0, _extends3.default)({}, data);
      if (_lodash2.default.startsWith(name, 'test-case')) {
        eventData.sourceLocation = sourceLocation;
      } else {
        eventData.testCase = { sourceLocation: sourceLocation };
      }
      this.eventBroadcaster.emit(name, eventData);
    }
  }, {
    key: 'emitPrepared',
    value: function emitPrepared() {
      var _this2 = this;

      var steps = [];
      this.beforeHookDefinitions.forEach(function (definition) {
        var actionLocation = { uri: definition.uri, line: definition.line };
        steps.push({ actionLocation: actionLocation });
      });
      this.testCase.pickle.steps.forEach(function (step) {
        var actionLocations = _this2.getStepDefinitions(step).map(function (definition) {
          return { uri: definition.uri, line: definition.line };
        });
        var sourceLocation = {
          uri: _this2.testCase.uri,
          line: _lodash2.default.last(step.locations).line
        };
        var data = { sourceLocation: sourceLocation };
        if (actionLocations.length === 1) {
          data.actionLocation = actionLocations[0];
        }
        steps.push(data);
      });
      this.afterHookDefinitions.forEach(function (definition) {
        var actionLocation = { uri: definition.uri, line: definition.line };
        steps.push({ actionLocation: actionLocation });
      });
      this.emit('test-case-prepared', { steps: steps });
    }
  }, {
    key: 'getAfterHookDefinitions',
    value: function getAfterHookDefinitions() {
      var _this3 = this;

      return this.supportCodeLibrary.afterTestCaseHookDefinitions.filter(function (hookDefinition) {
        return hookDefinition.appliesToTestCase(_this3.testCase);
      });
    }
  }, {
    key: 'getBeforeHookDefinitions',
    value: function getBeforeHookDefinitions() {
      var _this4 = this;

      return this.supportCodeLibrary.beforeTestCaseHookDefinitions.filter(function (hookDefinition) {
        return hookDefinition.appliesToTestCase(_this4.testCase);
      });
    }
  }, {
    key: 'getStepDefinitions',
    value: function getStepDefinitions(step) {
      var _this5 = this;

      return this.supportCodeLibrary.stepDefinitions.filter(function (stepDefinition) {
        return stepDefinition.matchesStepName({
          stepName: step.text,
          parameterTypeRegistry: _this5.supportCodeLibrary.parameterTypeRegistry
        });
      });
    }
  }, {
    key: 'invokeStep',
    value: function invokeStep(step, stepDefinition) {
      return _step_runner2.default.run({
        defaultTimeout: this.supportCodeLibrary.defaultTimeout,
        scenarioResult: this.scenarioResult,
        step: step,
        stepDefinition: stepDefinition,
        parameterTypeRegistry: this.supportCodeLibrary.parameterTypeRegistry,
        world: this.world
      });
    }
  }, {
    key: 'isSkippingSteps',
    value: function isSkippingSteps() {
      return this.result.status !== _status2.default.PASSED;
    }
  }, {
    key: 'shouldUpdateStatus',
    value: function shouldUpdateStatus(testStepResult) {
      switch (testStepResult.status) {
        case _status2.default.FAILED:
        case _status2.default.AMBIGUOUS:
          return this.result.status !== _status2.default.FAILED || this.result.status !== _status2.default.AMBIGUOUS;
        default:
          return this.result.status === _status2.default.PASSED || this.result.status === _status2.default.SKIPPED;
      }
    }
  }, {
    key: 'aroundTestStep',
    value: function () {
      var _ref3 = (0, _bluebird.coroutine)(function* (runStepFn) {
        this.emit('test-step-started', { index: this.testStepIndex });
        var testStepResult = yield runStepFn();
        if (testStepResult.duration) {
          this.result.duration += testStepResult.duration;
        }
        if (this.shouldUpdateStatus(testStepResult)) {
          this.result.status = testStepResult.status;
        }
        this.emit('test-step-finished', {
          index: this.testStepIndex,
          result: testStepResult
        });
        this.testStepIndex += 1;
      });

      function aroundTestStep(_x) {
        return _ref3.apply(this, arguments);
      }

      return aroundTestStep;
    }()
  }, {
    key: 'run',
    value: function () {
      var _ref4 = (0, _bluebird.coroutine)(function* () {
        this.emitPrepared();
        this.emit('test-case-started', {});
        yield this.runHooks(this.beforeHookDefinitions);
        yield this.runSteps();
        yield this.runHooks(this.afterHookDefinitions);
        this.emit('test-case-finished', { result: this.result });
        return this.result;
      });

      function run() {
        return _ref4.apply(this, arguments);
      }

      return run;
    }()
  }, {
    key: 'runHook',
    value: function () {
      var _ref5 = (0, _bluebird.coroutine)(function* (hookDefinition) {
        if (this.skip) {
          return { status: _status2.default.SKIPPED };
        } else {
          return yield this.invokeStep(null, hookDefinition);
        }
      });

      function runHook(_x2) {
        return _ref5.apply(this, arguments);
      }

      return runHook;
    }()
  }, {
    key: 'runHooks',
    value: function () {
      var _ref6 = (0, _bluebird.coroutine)(function* (hookDefinitions) {
        var _this6 = this;

        yield _bluebird2.default.each(hookDefinitions, function () {
          var _ref7 = (0, _bluebird.coroutine)(function* (hookDefinition) {
            yield _this6.aroundTestStep(function () {
              return _this6.runHook(hookDefinition);
            });
          });

          return function (_x4) {
            return _ref7.apply(this, arguments);
          };
        }());
      });

      function runHooks(_x3) {
        return _ref6.apply(this, arguments);
      }

      return runHooks;
    }()
  }, {
    key: 'runStep',
    value: function () {
      var _ref8 = (0, _bluebird.coroutine)(function* (step) {
        var stepDefinitions = this.getStepDefinitions(step);
        if (stepDefinitions.length === 0) {
          return { status: _status2.default.UNDEFINED };
        } else if (stepDefinitions.length > 1) {
          return {
            exception: (0, _helpers.getAmbiguousStepException)(stepDefinitions),
            status: _status2.default.AMBIGUOUS
          };
        } else if (this.isSkippingSteps()) {
          return { status: _status2.default.SKIPPED };
        } else {
          return yield this.invokeStep(step, stepDefinitions[0]);
        }
      });

      function runStep(_x5) {
        return _ref8.apply(this, arguments);
      }

      return runStep;
    }()
  }, {
    key: 'runSteps',
    value: function () {
      var _ref9 = (0, _bluebird.coroutine)(function* () {
        var _this7 = this;

        yield _bluebird2.default.each(this.testCase.pickle.steps, function () {
          var _ref10 = (0, _bluebird.coroutine)(function* (step) {
            yield _this7.aroundTestStep(function () {
              return _this7.runStep(step);
            });
          });

          return function (_x6) {
            return _ref10.apply(this, arguments);
          };
        }());
      });

      function runSteps() {
        return _ref9.apply(this, arguments);
      }

      return runSteps;
    }()
  }]);
  return TestCaseRunner;
}();

exports.default = TestCaseRunner;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ydW50aW1lL3Rlc3RfY2FzZV9ydW5uZXIuanMiXSwibmFtZXMiOlsiVGVzdENhc2VSdW5uZXIiLCJldmVudEJyb2FkY2FzdGVyIiwic2tpcCIsInRlc3RDYXNlIiwic3VwcG9ydENvZGVMaWJyYXJ5Iiwid29ybGRQYXJhbWV0ZXJzIiwiYXR0YWNobWVudE1hbmFnZXIiLCJkYXRhIiwibWVkaWEiLCJlbWl0IiwiaW5kZXgiLCJ0ZXN0U3RlcEluZGV4Iiwid29ybGQiLCJXb3JsZCIsImF0dGFjaCIsImNyZWF0ZSIsInBhcmFtZXRlcnMiLCJiZWZvcmVIb29rRGVmaW5pdGlvbnMiLCJnZXRCZWZvcmVIb29rRGVmaW5pdGlvbnMiLCJhZnRlckhvb2tEZWZpbml0aW9ucyIsImdldEFmdGVySG9va0RlZmluaXRpb25zIiwicmVzdWx0IiwiZHVyYXRpb24iLCJzdGF0dXMiLCJTS0lQUEVEIiwiUEFTU0VEIiwibmFtZSIsInNvdXJjZUxvY2F0aW9uIiwidXJpIiwibGluZSIsInBpY2tsZSIsImxvY2F0aW9ucyIsImV2ZW50RGF0YSIsInN0YXJ0c1dpdGgiLCJzdGVwcyIsImZvckVhY2giLCJhY3Rpb25Mb2NhdGlvbiIsImRlZmluaXRpb24iLCJwdXNoIiwiYWN0aW9uTG9jYXRpb25zIiwiZ2V0U3RlcERlZmluaXRpb25zIiwic3RlcCIsIm1hcCIsImxhc3QiLCJsZW5ndGgiLCJhZnRlclRlc3RDYXNlSG9va0RlZmluaXRpb25zIiwiZmlsdGVyIiwiaG9va0RlZmluaXRpb24iLCJhcHBsaWVzVG9UZXN0Q2FzZSIsImJlZm9yZVRlc3RDYXNlSG9va0RlZmluaXRpb25zIiwic3RlcERlZmluaXRpb25zIiwic3RlcERlZmluaXRpb24iLCJtYXRjaGVzU3RlcE5hbWUiLCJzdGVwTmFtZSIsInRleHQiLCJwYXJhbWV0ZXJUeXBlUmVnaXN0cnkiLCJydW4iLCJkZWZhdWx0VGltZW91dCIsInNjZW5hcmlvUmVzdWx0IiwidGVzdFN0ZXBSZXN1bHQiLCJGQUlMRUQiLCJBTUJJR1VPVVMiLCJydW5TdGVwRm4iLCJzaG91bGRVcGRhdGVTdGF0dXMiLCJlbWl0UHJlcGFyZWQiLCJydW5Ib29rcyIsInJ1blN0ZXBzIiwiaW52b2tlU3RlcCIsImhvb2tEZWZpbml0aW9ucyIsImVhY2giLCJhcm91bmRUZXN0U3RlcCIsInJ1bkhvb2siLCJVTkRFRklORUQiLCJleGNlcHRpb24iLCJpc1NraXBwaW5nU3RlcHMiLCJydW5TdGVwIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7Ozs7QUFDQTs7QUFDQTs7OztBQUVBOzs7O0FBQ0E7Ozs7OztJQUVxQkEsYztBQUNuQixnQ0FNRztBQUFBOztBQUFBLFFBTERDLGdCQUtDLFFBTERBLGdCQUtDO0FBQUEsUUFKREMsSUFJQyxRQUpEQSxJQUlDO0FBQUEsUUFIREMsUUFHQyxRQUhEQSxRQUdDO0FBQUEsUUFGREMsa0JBRUMsUUFGREEsa0JBRUM7QUFBQSxRQUREQyxlQUNDLFFBRERBLGVBQ0M7QUFBQTs7QUFDRCxRQUFNQyxvQkFBb0IsaUNBQXNCLGlCQUFxQjtBQUFBLFVBQWxCQyxJQUFrQixTQUFsQkEsSUFBa0I7QUFBQSxVQUFaQyxLQUFZLFNBQVpBLEtBQVk7O0FBQ25FLFlBQUtDLElBQUwsQ0FBVSxzQkFBVixFQUFrQztBQUNoQ0MsZUFBTyxNQUFLQyxhQURvQjtBQUVoQ0osa0JBRmdDO0FBR2hDQztBQUhnQyxPQUFsQztBQUtELEtBTnlCLENBQTFCO0FBT0EsU0FBS1AsZ0JBQUwsR0FBd0JBLGdCQUF4QjtBQUNBLFNBQUtDLElBQUwsR0FBWUEsSUFBWjtBQUNBLFNBQUtDLFFBQUwsR0FBZ0JBLFFBQWhCO0FBQ0EsU0FBS0Msa0JBQUwsR0FBMEJBLGtCQUExQjtBQUNBLFNBQUtRLEtBQUwsR0FBYSxJQUFJUixtQkFBbUJTLEtBQXZCLENBQTZCO0FBQ3hDQyxjQUFVUixrQkFBa0JTLE1BQTVCLE1BQVVULGlCQUFWLENBRHdDO0FBRXhDVSxrQkFBWVg7QUFGNEIsS0FBN0IsQ0FBYjtBQUlBLFNBQUtZ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QnpDLGMiLCJmaWxlIjoidGVzdF9jYXNlX3J1bm5lci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCdcbmltcG9ydCB7IGdldEFtYmlndW91c1N0ZXBFeGNlcHRpb24gfSBmcm9tICcuL2hlbHBlcnMnXG5pbXBvcnQgQXR0YWNobWVudE1hbmFnZXIgZnJvbSAnLi9hdHRhY2htZW50X21hbmFnZXInXG5pbXBvcnQgUHJvbWlzZSBmcm9tICdibHVlYmlyZCdcbmltcG9ydCBTdGF0dXMgZnJvbSAnLi4vc3RhdHVzJ1xuaW1wb3J0IFN0ZXBSdW5uZXIgZnJvbSAnLi9zdGVwX3J1bm5lcidcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgVGVzdENhc2VSdW5uZXIge1xuICBjb25zdHJ1Y3Rvcih7XG4gICAgZXZlbnRCcm9hZGNhc3RlcixcbiAgICBza2lwLFxuICAgIHRlc3RDYXNlLFxuICAgIHN1cHBvcnRDb2RlTGlicmFyeSxcbiAgICB3b3JsZFBhcmFtZXRlcnNcbiAgfSkge1xuICAgIGNvbnN0IGF0dGFjaG1lbnRNYW5hZ2VyID0gbmV3IEF0dGFjaG1lbnRNYW5hZ2VyKCh7IGRhdGEsIG1lZGlhIH0pID0+IHtcbiAgICAgIHRoaXMuZW1pdCgndGVzdC1zdGVwLWF0dGFjaG1lbnQnLCB7XG4gICAgICAgIGluZGV4OiB0aGlzLnRlc3RTdGVwSW5kZXgsXG4gICAgICAgIGRhdGEsXG4gICAgICAgIG1lZGlhXG4gICAgICB9KVxuICAgIH0pXG4gICAgdGhpcy5ldmVudEJyb2FkY2FzdGVyID0gZXZlbnRCcm9hZGNhc3RlclxuICAgIHRoaXMuc2tpcCA9IHNraXBcbiAgICB0aGlzLnRlc3RDYXNlID0gdGVzdENhc2VcbiAgICB0aGlzLnN1cHBvcnRDb2RlTGlicmFyeSA9IHN1cHBvcnRDb2RlTGlicmFyeVxuICAgIHRoaXMud29ybGQgPSBuZXcgc3VwcG9ydENvZGVMaWJyYXJ5LldvcmxkKHtcbiAgICAgIGF0dGFjaDogOjphdHRhY2htZW50TWFuYWdlci5jcmVhdGUsXG4gICAgICBwYXJhbWV0ZXJzOiB3b3JsZFBhcmFtZXRlcnNcbiAgICB9KVxuICAgIHRoaXMuYmVmb3JlSG9va0RlZmluaXRpb25zID0gdGhpcy5nZXRCZWZvcmVIb29rRGVmaW5pdGlvbnMoKVxuICAgIHRoaXMuYWZ0ZXJIb29rRGVmaW5pdGlvbnMgPSB0aGlzLmdldEFmdGVySG9va0RlZmluaXRpb25zKClcbiAgICB0aGlzLnRlc3RTdGVwSW5kZXggPSAwXG4gICAgdGhpcy5yZXN1bHQgPSB7XG4gICAgICBkdXJhdGlvbjogMCxcbiAgICAgIHN0YXR1czogdGhpcy5za2lwID8gU3RhdHVzLlNLSVBQRUQgOiBTdGF0dXMuUEFTU0VEXG4gICAgfVxuICB9XG5cbiAgZW1pdChuYW1lLCBkYXRhKSB7XG4gICAgbGV0IHNvdXJjZUxvY2F0aW9uID0ge1xuICAgICAgdXJpOiB0aGlzLnRlc3RDYXNlLnVyaSxcbiAgICAgIGxpbmU6IHRoaXMudGVzdENhc2UucGlja2xlLmxvY2F0aW9uc1swXS5saW5lXG4gICAgfVxuICAgIGxldCBldmVudERhdGEgPSB7IC4uLmRhdGEgfVxuICAgIGlmIChfLnN0YXJ0c1dpdGgobmFtZSwgJ3Rlc3QtY2FzZScpKSB7XG4gICAgICBldmVudERhdGEuc291cmNlTG9jYXRpb24gPSBzb3VyY2VMb2NhdGlvblxuICAgIH0gZWxzZSB7XG4gICAgICBldmVudERhdGEudGVzdENhc2UgPSB7IHNvdXJjZUxvY2F0aW9uIH1cbiAgICB9XG4gICAgdGhpcy5ldmVudEJyb2FkY2FzdGVyLmVtaXQobmFtZSwgZXZlbnREYXRhKVxuICB9XG5cbiAgZW1pdFByZXBhcmVkKCkge1xuICAgIGNvbnN0IHN0ZXBzID0gW11cbiAgICB0aGlzLmJlZm9yZUhvb2tEZWZpbml0aW9ucy5mb3JFYWNoKGRlZmluaXRpb24gPT4ge1xuICAgICAgY29uc3QgYWN0aW9uTG9jYXRpb24gPSB7IHVyaTogZGVmaW5pdGlvbi51cmksIGxpbmU6IGRlZmluaXRpb24ubGluZSB9XG4gICAgICBzdGVwcy5wdXNoKHsgYWN0aW9uTG9jYXRpb24gfSlcbiAgICB9KVxuICAgIHRoaXMudGVzdENhc2UucGlja2xlLnN0ZXBzLmZvckVhY2goc3RlcCA9PiB7XG4gICAgICBjb25zdCBhY3Rpb25Mb2NhdGlvbnMgPSB0aGlzLmdldFN0ZXBEZWZpbml0aW9ucyhzdGVwKS5tYXAoZGVmaW5pdGlvbiA9PiB7XG4gICAgICAgIHJldHVybiB7IHVyaTogZGVmaW5pdGlvbi51cmksIGxpbmU6IGRlZmluaXRpb24ubGluZSB9XG4gICAgICB9KVxuICAgICAgY29uc3Qgc291cmNlTG9jYXRpb24gPSB7XG4gICAgICAgIHVyaTogdGhpcy50ZXN0Q2FzZS51cmksXG4gICAgICAgIGxpbmU6IF8ubGFzdChzdGVwLmxvY2F0aW9ucykubGluZVxuICAgICAgfVxuICAgICAgY29uc3QgZGF0YSA9IHsgc291cmNlTG9jYXRpb24gfVxuICAgICAgaWYgKGFjdGlvbkxvY2F0aW9ucy5sZW5ndGggPT09IDEpIHtcbiAgICAgICAgZGF0YS5hY3Rpb25Mb2NhdGlvbiA9IGFjdGlvbkxvY2F0aW9uc1swXVxuICAgICAgfVxuICAgICAgc3RlcHMucHVzaChkYXRhKVxuICAgIH0pXG4gICAgdGhpcy5hZnRlckhvb2tEZWZpbml0aW9ucy5mb3JFYWNoKGRlZmluaXRpb24gPT4ge1xuICAgICAgY29uc3QgYWN0aW9uTG9jYXRpb24gPSB7IHVyaTogZGVmaW5pdGlvbi51cmksIGxpbmU6IGRlZmluaXRpb24ubGluZSB9XG4gICAgICBzdGVwcy5wdXNoKHsgYWN0aW9uTG9jYXRpb24gfSlcbiAgICB9KVxuICAgIHRoaXMuZW1pdCgndGVzdC1jYXNlLXByZXBhcmVkJywgeyBzdGVwcyB9KVxuICB9XG5cbiAgZ2V0QWZ0ZXJIb29rRGVmaW5pdGlvbnMoKSB7XG4gICAgcmV0dXJuIHRoaXMuc3VwcG9ydENvZGVMaWJyYXJ5LmFmdGVyVGVzdENhc2VIb29rRGVmaW5pdGlvbnMuZmlsdGVyKFxuICAgICAgaG9va0RlZmluaXRpb24gPT4ge1xuICAgICAgICByZXR1cm4gaG9va0RlZmluaXRpb24uYXBwbGllc1RvVGVzdENhc2UodGhpcy50ZXN0Q2FzZSlcbiAgICAgIH1cbiAgICApXG4gIH1cblxuICBnZXRCZWZvcmVIb29rRGVmaW5pdGlvbnMoKSB7XG4gICAgcmV0dXJuIHRoaXMuc3VwcG9ydENvZGVMaWJyYXJ5LmJlZm9yZVRlc3RDYXNlSG9va0RlZmluaXRpb25zLmZpbHRlcihcbiAgICAgIGhvb2tEZWZpbml0aW9uID0+IHtcbiAgICAgICAgcmV0dXJuIGhvb2tEZWZpbml0aW9uLmFwcGxpZXNUb1Rlc3RDYXNlKHRoaXMudGVzdENhc2UpXG4gICAgICB9XG4gICAgKVxuICB9XG5cbiAgZ2V0U3RlcERlZmluaXRpb25zKHN0ZXApIHtcbiAgICByZXR1cm4gdGhpcy5zdXBwb3J0Q29kZUxpYnJhcnkuc3RlcERlZmluaXRpb25zLmZpbHRlcihzdGVwRGVmaW5pdGlvbiA9PiB7XG4gICAgICByZXR1cm4gc3RlcERlZmluaXRpb24ubWF0Y2hlc1N0ZXBOYW1lKHtcbiAgICAgICAgc3RlcE5hbWU6IHN0ZXAudGV4dCxcbiAgICAgICAgcGFyYW1ldGVyVHlwZVJlZ2lzdHJ5OiB0aGlzLnN1cHBvcnRDb2RlTGlicmFyeS5wYXJhbWV0ZXJUeXBlUmVnaXN0cnlcbiAgICAgIH0pXG4gICAgfSlcbiAgfVxuXG4gIGludm9rZVN0ZXAoc3RlcCwgc3RlcERlZmluaXRpb24pIHtcbiAgICByZXR1cm4gU3RlcFJ1bm5lci5ydW4oe1xuICAgICAgZGVmYXVsdFRpbWVvdXQ6IHRoaXMuc3VwcG9ydENvZGVMaWJyYXJ5LmRlZmF1bHRUaW1lb3V0LFxuICAgICAgc2NlbmFyaW9SZXN1bHQ6IHRoaXMuc2NlbmFyaW9SZXN1bHQsXG4gICAgICBzdGVwLFxuICAgICAgc3RlcERlZmluaXRpb24sXG4gICAgICBwYXJhbWV0ZXJUeXBlUmVnaXN0cnk6IHRoaXMuc3VwcG9ydENvZGVMaWJyYXJ5LnBhcmFtZXRlclR5cGVSZWdpc3RyeSxcbiAgICAgIHdvcmxkOiB0aGlzLndvcmxkXG4gICAgfSlcbiAgfVxuXG4gIGlzU2tpcHBpbmdTdGVwcygpIHtcbiAgICByZXR1cm4gdGhpcy5yZXN1bHQuc3RhdHVzICE9PSBTdGF0dXMuUEFTU0VEXG4gIH1cblxuICBzaG91bGRVcGRhdGVTdGF0dXModGVzdFN0ZXBSZXN1bHQpIHtcbiAgICBzd2l0Y2ggKHRlc3RTdGVwUmVzdWx0LnN0YXR1cykge1xuICAgICAgY2FzZSBTdGF0dXMuRkFJTEVEOlxuICAgICAgY2FzZSBTdGF0dXMuQU1CSUdVT1VTOlxuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgIHRoaXMucmVzdWx0LnN0YXR1cyAhPT0gU3RhdHVzLkZBSUxFRCB8fFxuICAgICAgICAgIHRoaXMucmVzdWx0LnN0YXR1cyAhPT0gU3RhdHVzLkFNQklHVU9VU1xuICAgICAgICApXG4gICAgICBkZWZhdWx0OlxuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgIHRoaXMucmVzdWx0LnN0YXR1cyA9PT0gU3RhdHVzLlBBU1NFRCB8fFxuICAgICAgICAgIHRoaXMucmVzdWx0LnN0YXR1cyA9PT0gU3RhdHVzLlNLSVBQRURcbiAgICAgICAgKVxuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGFyb3VuZFRlc3RTdGVwKHJ1blN0ZXBGbikge1xuICAgIHRoaXMuZW1pdCgndGVzdC1zdGVwLXN0YXJ0ZWQnLCB7IGluZGV4OiB0aGlzLnRlc3RTdGVwSW5kZXggfSlcbiAgICBjb25zdCB0ZXN0U3RlcFJlc3VsdCA9IGF3YWl0IHJ1blN0ZXBGbigpXG4gICAgaWYgKHRlc3RTdGVwUmVzdWx0LmR1cmF0aW9uKSB7XG4gICAgICB0aGlzLnJlc3VsdC5kdXJhdGlvbiArPSB0ZXN0U3RlcFJlc3VsdC5kdXJhdGlvblxuICAgIH1cbiAgICBpZiAodGhpcy5zaG91bGRVcGRhdGVTdGF0dXModGVzdFN0ZXBSZXN1bHQpKSB7XG4gICAgICB0aGlzLnJlc3VsdC5zdGF0dXMgPSB0ZXN0U3RlcFJlc3VsdC5zdGF0dXNcbiAgICB9XG4gICAgdGhpcy5lbWl0KCd0ZXN0LXN0ZXAtZmluaXNoZWQnLCB7XG4gICAgICBpbmRleDogdGhpcy50ZXN0U3RlcEluZGV4LFxuICAgICAgcmVzdWx0OiB0ZXN0U3RlcFJlc3VsdFxuICAgIH0pXG4gICAgdGhpcy50ZXN0U3RlcEluZGV4ICs9IDFcbiAgfVxuXG4gIGFzeW5jIHJ1bigpIHtcbiAgICB0aGlzLmVtaXRQcmVwYXJlZCgpXG4gICAgdGhpcy5lbWl0KCd0ZXN0LWNhc2Utc3RhcnRlZCcsIHt9KVxuICAgIGF3YWl0IHRoaXMucnVuSG9va3ModGhpcy5iZWZvcmVIb29rRGVmaW5pdGlvbnMpXG4gICAgYXdhaXQgdGhpcy5ydW5TdGVwcygpXG4gICAgYXdhaXQgdGhpcy5ydW5Ib29rcyh0aGlzLmFmdGVySG9va0RlZmluaXRpb25zKVxuICAgIHRoaXMuZW1pdCgndGVzdC1jYXNlLWZpbmlzaGVkJywgeyByZXN1bHQ6IHRoaXMucmVzdWx0IH0pXG4gICAgcmV0dXJuIHRoaXMucmVzdWx0XG4gIH1cblxuICBhc3luYyBydW5Ib29rKGhvb2tEZWZpbml0aW9uKSB7XG4gICAgaWYgKHRoaXMuc2tpcCkge1xuICAgICAgcmV0dXJuIHsgc3RhdHVzOiBTdGF0dXMuU0tJUFBFRCB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLmludm9rZVN0ZXAobnVsbCwgaG9va0RlZmluaXRpb24pXG4gICAgfVxuICB9XG5cbiAgYXN5bmMgcnVuSG9va3MoaG9va0RlZmluaXRpb25zKSB7XG4gICAgYXdhaXQgUHJvbWlzZS5lYWNoKGhvb2tEZWZpbml0aW9ucywgYXN5bmMgaG9va0RlZmluaXRpb24gPT4ge1xuICAgICAgYXdhaXQgdGhpcy5hcm91bmRUZXN0U3RlcCgoKSA9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLnJ1bkhvb2soaG9va0RlZmluaXRpb24pXG4gICAgICB9KVxuICAgIH0pXG4gIH1cblxuICBhc3luYyBydW5TdGVwKHN0ZXApIHtcbiAgICBjb25zdCBzdGVwRGVmaW5pdGlvbnMgPSB0aGlzLmdldFN0ZXBEZWZpbml0aW9ucyhzdGVwKVxuICAgIGlmIChzdGVwRGVmaW5pdGlvbnMubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm4geyBzdGF0dXM6IFN0YXR1cy5VTkRFRklORUQgfVxuICAgIH0gZWxzZSBpZiAoc3RlcERlZmluaXRpb25zLmxlbmd0aCA+IDEpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGV4Y2VwdGlvbjogZ2V0QW1iaWd1b3VzU3RlcEV4Y2VwdGlvbihzdGVwRGVmaW5pdGlvbnMpLFxuICAgICAgICBzdGF0dXM6IFN0YXR1cy5BTUJJR1VPVVNcbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKHRoaXMuaXNTa2lwcGluZ1N0ZXBzKCkpIHtcbiAgICAgIHJldHVybiB7IHN0YXR1czogU3RhdHVzLlNLSVBQRUQgfVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5pbnZva2VTdGVwKHN0ZXAsIHN0ZXBEZWZpbml0aW9uc1swXSlcbiAgICB9XG4gIH1cblxuICBhc3luYyBydW5TdGVwcygpIHtcbiAgICBhd2FpdCBQcm9taXNlLmVhY2godGhpcy50ZXN0Q2FzZS5waWNrbGUuc3RlcHMsIGFzeW5jIHN0ZXAgPT4ge1xuICAgICAgYXdhaXQgdGhpcy5hcm91bmRUZXN0U3RlcCgoKSA9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLnJ1blN0ZXAoc3RlcClcbiAgICAgIH0pXG4gICAgfSlcbiAgfVxufVxuIl19